<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loup vs Villageois</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        #root {
            width: 100vw;
            height: 100vh;
        }

        .menu-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
        }

        .title {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 3rem;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .btn {
            padding: 1rem 3rem;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ee5a52;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: #4ecdc4;
            color: white;
        }

        .btn-secondary:hover {
            background: #45b8b0;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.3);
        }

        .btn-back {
            background: #95a5a6;
            color: white;
            padding: 0.7rem 2rem;
            font-size: 1rem;
        }

        .lobby-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            color: white;
        }

        .lobby-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .lobby-content {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-item label {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .setting-item select,
        .setting-item input {
            padding: 0.7rem;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
        }

        .players-list {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .player-item {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-list {
            display: grid;
            gap: 1rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .game-item {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .game-info {
            flex: 1;
        }

        .game-canvas {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #2d5016;
            overflow: hidden;
        }

        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            transition: opacity 0.3s;
            border: 3px solid rgba(255,255,255,0.5);
            font-size: 1.5rem;
        }

        .wolf {
            background: #8b0000;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
        }

        .villager {
            background: #4169e1;
            box-shadow: 0 0 10px rgba(65,105,225,0.5);
        }

        .invisible {
            opacity: 0.3;
        }

        .lake {
            position: absolute;
            background: radial-gradient(circle, #5da3e8 0%, #3a7fc4 100%);
            border-radius: 50%;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.4);
        }

        .house {
            position: absolute;
            background: #8b4513;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .house::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -10px;
            width: 120%;
            height: 30px;
            background: #a0522d;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .tree {
            position: absolute;
            width: 30px;
            height: 40px;
            background: #654321;
            border-radius: 5px;
        }

        .tree::before {
            content: 'üå≤';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
        }

        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }

        .countdown-number {
            font-size: 10rem;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .game-ui {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 1.5rem;
            border-radius: 15px;
            color: white;
            min-width: 400px;
            text-align: center;
            z-index: 100;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #ffd700;
        }

        .powers {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .power-btn {
            padding: 0.8rem 1.5rem;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .power-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.4);
            transform: scale(1.05);
        }

        .power-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .scores {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 1rem;
            border-radius: 10px;
            color: white;
            z-index: 100;
            min-width: 200px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .score-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .end-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }

        .end-title {
            font-size: 4rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px rgba(255,215,0,0.5);
        }

        .final-scores {
            background: rgba(255,255,255,0.1);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            min-width: 400px;
        }

        .direction-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            color: rgba(255,255,255,0.8);
            z-index: 50;
            pointer-events: none;
            animation: pulse 0.5s infinite;
            text-shadow: 0 0 30px rgba(255,255,255,0.8);
        }

        .firebase-warning {
            background: rgba(255,193,7,0.2);
            border: 2px solid #ffc107;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .player-name-tag {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.7rem;
            white-space: nowrap;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCi_dIuvLuZkZ8jm9JGNS-X_kpdTRiwEQs",
            authDomain: "runwolf-bb3cd.firebaseapp.com",
            databaseURL: "https://runwolf-bb3cd-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "runwolf-bb3cd",
            storageBucket: "runwolf-bb3cd.firebasestorage.app",
            messagingSenderId: "551801656707",
            appId: "1:551801656707:web:8fc191cebe5bc6a2ad12b6",
            measurementId: "G-1DHQCQNV8N"
        };

        // Initialiser Firebase
        let database = null;
        let firebaseInitialized = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseInitialized = true;
            console.log("Firebase initialis√© avec succ√®s !");
        } catch (error) {
            console.error("Erreur d'initialisation Firebase:", error);
        }

        function App() {
            const [screen, setScreen] = useState('menu');
            const [playerName, setPlayerName] = useState('');
            const [gameId, setGameId] = useState('');
            const [playerId, setPlayerId] = useState(Math.random().toString(36).substr(2, 9));

            useEffect(() => {
                const name = localStorage.getItem('playerName');
                if (name) setPlayerName(name);
            }, []);

            const savePlayerName = (name) => {
                setPlayerName(name);
                localStorage.setItem('playerName', name);
            };

            if (!firebaseInitialized) {
                return (
                    <div className="menu-container">
                        <h1 className="title">üê∫ Loup vs Villageois</h1>
                        <div className="lobby-content" style={{maxWidth: '800px'}}>
                            <div className="firebase-warning">
                                <h2 style={{marginBottom: '1rem'}}>‚ö†Ô∏è Configuration Firebase requise</h2>
                                <p style={{marginBottom: '1rem'}}>
                                    Pour utiliser ce jeu multijoueur, vous devez configurer Firebase :
                                </p>
                                <ol style={{textAlign: 'left', marginLeft: '2rem', marginBottom: '1rem'}}>
                                    <li>Allez sur <a href="https://console.firebase.google.com" target="_blank" style={{color: '#4ecdc4'}}>console.firebase.google.com</a></li>
                                    <li>Cr√©ez un nouveau projet (gratuit)</li>
                                    <li>Activez "Realtime Database"</li>
                                    <li>Dans les param√®tres du projet, copiez les cl√©s de configuration</li>
                                    <li>Remplacez les valeurs dans le fichier HTML (ligne ~270)</li>
                                    <li>Dans les r√®gles de la database, mettez : <code>{`{ "rules": { ".read": true, ".write": true } }`}</code></li>
                                </ol>
                                <p style={{fontSize: '0.9rem', opacity: 0.8}}>
                                    Firebase est gratuit jusqu'√† 100 utilisateurs simultan√©s
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (!playerName) {
                return <PlayerNameScreen onSubmit={savePlayerName} />;
            }

            return (
                <>
                    {screen === 'menu' && <MainMenu setScreen={setScreen} />}
                    {screen === 'create' && (
                        <CreateGameScreen 
                            playerName={playerName}
                            playerId={playerId}
                            setScreen={setScreen}
                            setGameId={setGameId}
                        />
                    )}
                    {screen === 'join' && (
                        <JoinGameScreen 
                            playerName={playerName}
                            playerId={playerId}
                            setScreen={setScreen}
                            setGameId={setGameId}
                        />
                    )}
                    {screen === 'lobby' && (
                        <LobbyScreen 
                            gameId={gameId}
                            playerName={playerName}
                            playerId={playerId}
                            setScreen={setScreen}
                        />
                    )}
                    {screen === 'game' && (
                        <GameScreen 
                            gameId={gameId}
                            playerName={playerName}
                            playerId={playerId}
                            setScreen={setScreen}
                        />
                    )}
                </>
            );
        }

        function PlayerNameScreen({ onSubmit }) {
            const [name, setName] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (name.trim()) {
                    onSubmit(name.trim());
                }
            };

            return (
                <div className="menu-container">
                    <h1 className="title">üê∫ Loup vs Villageois</h1>
                    <form onSubmit={handleSubmit} style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                        <input
                            type="text"
                            placeholder="Votre nom..."
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            style={{padding: '1rem', fontSize: '1.2rem', borderRadius: '8px', border: 'none', minWidth: '300px'}}
                            autoFocus
                            maxLength={15}
                        />
                        <button type="submit" className="btn btn-primary">Commencer</button>
                    </form>
                </div>
            );
        }

        function MainMenu({ setScreen }) {
            return (
                <div className="menu-container">
                    <h1 className="title">üê∫ Loup vs Villageois</h1>
                    <div className="menu-buttons">
                        <button className="btn btn-primary" onClick={() => setScreen('create')}>
                            Cr√©er une partie
                        </button>
                        <button className="btn btn-secondary" onClick={() => setScreen('join')}>
                            Rejoindre une partie
                        </button>
                    </div>
                </div>
            );
        }

        function CreateGameScreen({ playerName, playerId, setScreen, setGameId }) {
            const [rounds, setRounds] = useState(3);
            const [atouts, setAtouts] = useState(true);
            const [creating, setCreating] = useState(false);

            const handleCreate = async () => {
                setCreating(true);
                const id = Math.random().toString(36).substr(2, 6).toUpperCase();
                
                const game = {
                    id,
                    host: playerId,
                    rounds: parseInt(rounds),
                    atouts,
                    players: {
                        [playerId]: {
                            id: playerId,
                            name: playerName,
                            score: 0
                        }
                    },
                    status: 'waiting',
                    createdAt: Date.now()
                };

                try {
                    await database.ref('games/' + id).set(game);
                    setGameId(id);
                    setScreen('lobby');
                } catch (error) {
                    console.error('Erreur cr√©ation:', error);
                    alert('Erreur lors de la cr√©ation de la partie');
                    setCreating(false);
                }
            };

            return (
                <div className="lobby-container">
                    <div className="lobby-header">
                        <h1 className="title" style={{fontSize: '3rem'}}>Cr√©er une partie</h1>
                    </div>
                    <div className="lobby-content">
                        <div className="settings-grid">
                            <div className="setting-item">
                                <label>Nombre de rounds :</label>
                                <select value={rounds} onChange={(e) => setRounds(e.target.value)}>
                                    <option value="1">1 round</option>
                                    <option value="2">2 rounds</option>
                                    <option value="3">3 rounds</option>
                                    <option value="4">4 rounds</option>
                                    <option value="5">5 rounds</option>
                                </select>
                            </div>
                            <div className="setting-item">
                                <label>Atouts :</label>
                                <select value={atouts} onChange={(e) => setAtouts(e.target.value === 'true')}>
                                    <option value="true">Oui</option>
                                    <option value="false">Non</option>
                                </select>
                            </div>
                        </div>
                        <div style={{display: 'flex', gap: '1rem', justifyContent: 'center'}}>
                            <button className="btn btn-back" onClick={() => setScreen('menu')}>
                                Retour
                            </button>
                            <button 
                                className="btn btn-primary" 
                                onClick={handleCreate}
                                disabled={creating}
                            >
                                {creating ? 'Cr√©ation...' : 'Cr√©er la partie'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function JoinGameScreen({ playerName, playerId, setScreen, setGameId }) {
            const [games, setGames] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const gamesRef = database.ref('games');
                
                const listener = gamesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const gamesList = Object.values(data).filter(game => 
                            game.status === 'waiting' && 
                            Object.keys(game.players).length < 8
                        );
                        setGames(gamesList);
                    } else {
                        setGames([]);
                    }
                    setLoading(false);
                });

                return () => gamesRef.off('value', listener);
            }, []);

            const handleJoin = async (game) => {
                if (game.players[playerId]) {
                    setGameId(game.id);
                    setScreen('lobby');
                    return;
                }

                try {
                    await database.ref(`games/${game.id}/players/${playerId}`).set({
                        id: playerId,
                        name: playerName,
                        score: 0
                    });
                    setGameId(game.id);
                    setScreen('lobby');
                } catch (error) {
                    alert('Erreur lors de la connexion');
                }
            };

            return (
                <div className="lobby-container">
                    <div className="lobby-header">
                        <h1 className="title" style={{fontSize: '3rem'}}>Parties disponibles</h1>
                    </div>
                    <div className="lobby-content">
                        {loading ? (
                            <p style={{textAlign: 'center', fontSize: '1.3rem'}}>Chargement...</p>
                        ) : games.length === 0 ? (
                            <p style={{textAlign: 'center', fontSize: '1.3rem'}}>Aucune partie disponible</p>
                        ) : (
                            <div className="game-list">
                                {games.map(game => (
                                    <div key={game.id} className="game-item">
                                        <div className="game-info">
                                            <h3 style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>
                                                Partie #{game.id}
                                            </h3>
                                            <p>Joueurs: {Object.keys(game.players).length}/8</p>
                                            <p>Rounds: {game.rounds} | Atouts: {game.atouts ? 'Oui' : 'Non'}</p>
                                        </div>
                                        <button 
                                            className="btn btn-primary"
                                            onClick={() => handleJoin(game)}
                                        >
                                            Rejoindre
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}
                        <button 
                            className="btn btn-back" 
                            onClick={() => setScreen('menu')}
                            style={{marginTop: '2rem'}}
                        >
                            Retour
                        </button>
                    </div>
                </div>
            );
        }

        function LobbyScreen({ gameId, playerName, playerId, setScreen }) {
            const [game, setGame] = useState(null);

            useEffect(() => {
                const gameRef = database.ref('games/' + gameId);
                
                const listener = gameRef.on('value', (snapshot) => {
                    const gameData = snapshot.val();
                    if (gameData) {
                        setGame(gameData);
                        
                        if (gameData.status === 'playing') {
                            setScreen('game');
                        }
                    } else {
                        setScreen('menu');
                    }
                });

                return () => gameRef.off('value', listener);
            }, [gameId]);

            const handleStart = async () => {
                if (!game || Object.keys(game.players).length < 2) {
                    alert('Il faut au moins 2 joueurs pour commencer');
                    return;
                }

                try {
                    await database.ref(`games/${gameId}`).update({
                        status: 'playing',
                        currentRound: 1
                    });
                } catch (error) {
                    alert('Erreur au d√©marrage');
                }
            };

            const handleLeave = async () => {
                if (!game) return;

                try {
                    await database.ref(`games/${gameId}/players/${playerId}`).remove();
                    
                    const snapshot = await database.ref(`games/${gameId}/players`).once('value');
                    const remainingPlayers = snapshot.val();
                    
                    if (!remainingPlayers || Object.keys(remainingPlayers).length === 0) {
                        await database.ref(`games/${gameId}`).remove();
                    } else if (game.host === playerId) {
                        const newHost = Object.keys(remainingPlayers)[0];
                        await database.ref(`games/${gameId}/host`).set(newHost);
                    }
                    
                    setScreen('menu');
                } catch (error) {
                    setScreen('menu');
                }
            };

            if (!game) {
                return <div className="menu-container"><p>Chargement...</p></div>;
            }

            const isHost = game.host === playerId;
            const playersList = Object.values(game.players);

            return (
                <div className="lobby-container">
                    <div className="lobby-header">
                        <h1 className="title" style={{fontSize: '3rem'}}>Salon - #{gameId}</h1>
                    </div>
                    <div className="lobby-content">
                        <div className="players-list">
                            <h2 style={{marginBottom: '1rem', fontSize: '1.5rem'}}>
                                Joueurs ({playersList.length}/8)
                            </h2>
                            {playersList.map(player => (
                                <div key={player.id} className="player-item">
                                    <span style={{fontSize: '1.2rem'}}>
                                        {player.name} {player.id === game.host && 'üëë'}
                                    </span>
                                </div>
                            ))}
                        </div>
                        
                        <div style={{marginBottom: '2rem', textAlign: 'center'}}>
                            <p style={{fontSize: '1.2rem'}}>Rounds: {game.rounds}</p>
                            <p style={{fontSize: '1.2rem'}}>Atouts: {game.atouts ? 'Oui' : 'Non'}</p>
                        </div>

                        <div style={{display: 'flex', gap: '1rem', justifyContent: 'center'}}>
                            <button className="btn btn-back" onClick={handleLeave}>
                                Quitter
                            </button>
                            {isHost && (
                                <button 
                                    className="btn btn-primary"
                                    onClick={handleStart}
                                    disabled={playersList.length < 2}
                                >
                                    D√©marrer la partie
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function GameScreen({ gameId, playerName, playerId, setScreen }) {
            const [game, setGame] = useState(null);
            const [countdown, setCountdown] = useState(null);
            const [gameTime, setGameTime] = useState(0);
            const [positions, setPositions] = useState({});
            const [wolf, setWolf] = useState(null);
            const [roundEnded, setRoundEnded] = useState(false);
            const [gameEnded, setGameEnded] = useState(false);
            const [powers, setPowers] = useState({
                invisibility: 1,
                run: 2,
                pouf: 2,
                omniscience: 2
            });
            const [activePower, setActivePower] = useState(null);
            const [powerTimer, setPowerTimer] = useState(0);
            const [directionIndicator, setDirectionIndicator] = useState(null);
            const [caughtPlayers, setCaughtPlayers] = useState({});
            const [usedPowersCount, setUsedPowersCount] = useState(0);

            const keysPressed = useRef({});
            const gameStartTime = useRef(null);

            useEffect(() => {
                const gameRef = database.ref('games/' + gameId);
                
                const listener = gameRef.on('value', (snapshot) => {
                    const gameData = snapshot.val();
                    if (gameData) {
                        setGame(gameData);
                        
                        if (!wolf && gameData.wolf) {
                            setWolf(gameData.wolf);
                            if (gameData.wolf === playerId) {
                                setCountdown(10);
                            }
                        }

                        if (gameData.roundEnd) {
                            setRoundEnded(true);
                        }

                        if (gameData.status === 'finished') {
                            setGameEnded(true);
                        }
                    }
                });

                return () => gameRef.off('value', listener);
            }, [gameId]);

            useEffect(() => {
                if (!game || wolf) return;

                const initWolf = async () => {
                    const playersList = Object.keys(game.players);
                    const wolfIndex = Math.floor(Math.random() * playersList.length);
                    const selectedWolf = playersList[wolfIndex];
                    
                    await database.ref(`games/${gameId}/wolf`).set(selectedWolf);
                    setWolf(selectedWolf);

                    const initialPositions = {};
                    playersList.forEach(pId => {
                        initialPositions[pId] = {
                            x: Math.random() * (window.innerWidth - 200) + 100,
                            y: Math.random() * (window.innerHeight - 200) + 100
                        };
                    });
                    setPositions(initialPositions);
                    gameStartTime.current = Date.now();
                };

                initWolf();
            }, [game]);

            useEffect(() => {
                if (countdown !== null && countdown > 0) {
                    const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (countdown === 0) {
                    setCountdown(null);
                    gameStartTime.current = Date.now();
                }
            }, [countdown]);

            useEffect(() => {
                if (countdown === null && !roundEnded && !gameEnded && gameStartTime.current) {
                    const timer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - gameStartTime.current) / 1000);
                        setGameTime(elapsed);
                    }, 100);
                    return () => clearInterval(timer);
                }
            }, [countdown, roundEnded, gameEnded]);

            useEffect(() => {
                if (powerTimer > 0) {
                    const timer = setTimeout(() => {
                        setPowerTimer(powerTimer - 1);
                        if (powerTimer === 1) {
                            setActivePower(null);
                        }
                    }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [powerTimer]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    keysPressed.current[e.key.toLowerCase()] = true;
                };
                const handleKeyUp = (e) => {
                    keysPressed.current[e.key.toLowerCase()] = false;
                };

                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);

                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                };
            }, []);

            useEffect(() => {
                if (countdown === null && !roundEnded && !gameEnded && positions[playerId]) {
                    const moveInterval = setInterval(movePlayer, 30);
                    return () => clearInterval(moveInterval);
                }
            }, [countdown, roundEnded, gameEnded, positions, activePower, gameTime]);

            useEffect(() => {
                if (gameTime >= 80 && !roundEnded && !gameEnded && wolf === playerId) {
                    const uncaughtCount = Object.keys(game.players).length - Object.keys(caughtPlayers).length - 1;
                    if (uncaughtCount > 0) {
                        endRound(0);
                    }
                }
            }, [gameTime]);

            const movePlayer = () => {
                if (!positions[playerId] || caughtPlayers[playerId]) return;

                let speed = 5;
                const isWolf = wolf === playerId;

                if (isWolf) {
                    if (gameTime < 60) speed = 5;
                    else if (gameTime < 80) speed = 10;
                    
                    if (activePower === 'omniscience') {
                        speed = 7.5;
                    }
                } else {
                    if (activePower === 'invisibility') {
                        speed = 10;
                    } else if (activePower === 'run') {
                        speed = 12.5;
                    }
                }

                let dx = 0;
                let dy = 0;

                if (keysPressed.current['z'] || keysPressed.current['arrowup']) dy -= speed;
                if (keysPressed.current['s'] || keysPressed.current['arrowdown']) dy += speed;
                if (keysPressed.current['q'] || keysPressed.current['arrowleft']) dx -= speed;
                if (keysPressed.current['d'] || keysPressed.current['arrowright']) dx += speed;

                if (dx !== 0 || dy !== 0) {
                    setPositions(prev => {
                        const newX = Math.max(20, Math.min(window.innerWidth - 60, prev[playerId].x + dx));
                        const newY = Math.max(20, Math.min(window.innerHeight - 60, prev[playerId].y + dy));

                        return {
                            ...prev,
                            [playerId]: { x: newX, y: newY }
                        };
                    });

                    if (isWolf) {
                        checkCollisions();
                    }
                }
            };

            const checkCollisions = () => {
                if (!wolf || wolf !== playerId) return;

                Object.keys(positions).forEach(pId => {
                    if (pId !== wolf && !caughtPlayers[pId]) {
                        const dx = positions[wolf].x - positions[pId].x;
                        const dy = positions[wolf].y - positions[pId].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance < 50) {
                            setCaughtPlayers(prev => ({ ...prev, [pId]: true }));
                            endRound(gameTime < 60 ? 10 : 5);
                        }
                    }
                });
            };

            const usePower = (powerType) => {
                if (powers[powerType] <= 0 || activePower) return;

                if (powerType === 'pouf') {
                    setPositions(prev => {
                        const wolfPos = prev[wolf];
                        const villagerPos = prev[playerId];

                        return {
                            ...prev,
                            [wolf]: { x: villagerPos.x, y: villagerPos.y },
                            [playerId]: { x: wolfPos.x, y: wolfPos.y }
                        };
                    });

                    setPowers(prev => ({ ...prev, pouf: prev.pouf - 1 }));
                    setUsedPowersCount(prev => prev + 1);
                } else if (powerType === 'omniscience') {
                    const villagers = Object.keys(positions).filter(p => p !== wolf && !caughtPlayers[p]);
                    if (villagers.length === 0) return;

                    let closestVillager = villagers[0];
                    let minDist = Infinity;
                    villagers.forEach(vId => {
                        const dx = positions[vId].x - positions[playerId].x;
                        const dy = positions[vId].y - positions[playerId].y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < minDist) {
                            minDist = dist;
                            closestVillager = vId;
                        }
                    });

                    const dx = positions[closestVillager].x - positions[playerId].x;
                    const dy = positions[closestVillager].y - positions[playerId].y;

                    let arrow = '‚Üë';
                    if (Math.abs(dx) > Math.abs(dy)) {
                        arrow = dx > 0 ? '‚Üí' : '‚Üê';
                    } else {
                        arrow = dy > 0 ? '‚Üì' : '‚Üë';
                    }

                    setDirectionIndicator(arrow);
                    setTimeout(() => setDirectionIndicator(null), 3000);

                    setActivePower('omniscience');
                    setPowerTimer(3);
                    setPowers(prev => ({ ...prev, omniscience: prev.omniscience - 1 }));
                } else {
                    setActivePower(powerType);
                    setPowerTimer(powerType === 'invisibility' ? 7 : 5);
                    setPowers(prev => ({ ...prev, [powerType]: prev[powerType] - 1 }));
                    setUsedPowersCount(prev => prev + 1);
                }
            };

            const endRound = async (wolfPoints) => {
                if (roundEnded) return;
                setRoundEnded(true);

                const updatedPlayers = { ...game.players };
                
                updatedPlayers[wolf].score += wolfPoints;

                Object.keys(game.players).forEach(pId => {
                    if (pId !== wolf && !caughtPlayers[pId]) {
                        const deduction = wolf === playerId ? 0 : usedPowersCount * 2;
                        updatedPlayers[pId].score += Math.max(0, 20 - deduction);
                    }
                });

                const nextRound = (game.currentRound || 1) + 1;
                const isGameOver = nextRound > game.rounds;

                try {
                    await database.ref(`games/${gameId}`).update({
                        players: updatedPlayers,
                        currentRound: nextRound,
                        roundEnd: true,
                        status: isGameOver ? 'finished' : 'playing'
                    });

                    if (isGameOver) {
                        setGameEnded(true);
                    } else {
                        setTimeout(() => {
                            window.location.reload();
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Erreur fin round:', error);
                }
            };

            if (!game || !positions[playerId]) {
                return <div className="menu-container"><p>Chargement...</p></div>;
            }

            const isWolf = wolf === playerId;
            const playersList = Object.values(game.players);

            return (
                <div className="game-canvas">
                    {countdown !== null && (
                        <div className="countdown-overlay">
                            <h2 style={{fontSize: '3rem', marginBottom: '2rem'}}>VOUS √äTES LE LOUP!</h2>
                            <div className="countdown-number">{countdown === 0 ? 'RUN!' : countdown}</div>
                        </div>
                    )}

                    {countdown === null && (
                        <>
                            <div className="game-ui">
                                <div className="timer">
                                    {Math.floor(Math.max(0, 80 - gameTime) / 60)}:{String(Math.max(0, 80 - gameTime) % 60).padStart(2, '0')}
                                </div>
                                <p style={{fontSize: '1.2rem', marginBottom: '0.5rem'}}>
                                    Vous √™tes: {isWolf ? 'üê∫ LOUP' : 'üë§ VILLAGEOIS'}
                                </p>
                                
                                {!isWolf && game.atouts && (
                                    <div className="powers">
                                        <button
                                            className="power-btn"
                                            onClick={() => usePower('invisibility')}
                                            disabled={powers.invisibility === 0 || activePower}
                                        >
                                            üëª Invisibilit√© ({powers.invisibility})
                                        </button>
                                        <button
                                            className="power-btn"
                                            onClick={() => usePower('run')}
                                            disabled={powers.run === 0 || activePower}
                                        >
                                            üí® Run! ({powers.run})
                                        </button>
                                        <button
                                            className="power-btn"
                                            onClick={() => usePower('pouf')}
                                            disabled={powers.pouf === 0 || activePower}
                                        >
                                            ‚ú® Pouf! ({powers.pouf})
                                        </button>
                                    </div>
                                )}

                                {isWolf && game.atouts && (
                                    <div className="powers">
                                        <button
                                            className="power-btn"
                                            onClick={() => usePower('omniscience')}
                                            disabled={powers.omniscience === 0 || activePower}
                                        >
                                            üîÆ Omniscience ({powers.omniscience})
                                        </button>
                                    </div>
                                )}

                                {activePower && (
                                    <p style={{marginTop: '0.5rem', color: '#ffd700'}}>
                                        ‚ö° Pouvoir actif: {powerTimer}s
                                    </p>
                                )}
                            </div>

                            <div className="scores">
                                <h3 style={{marginBottom: '0.8rem', fontSize: '1.1rem'}}>Scores</h3>
                                {playersList
                                    .sort((a, b) => b.score - a.score)
                                    .map(p => (
                                        <div key={p.id} className="score-item">
                                            {p.name}: {p.score}pts
                                        </div>
                                    ))}
                                <p style={{marginTop: '0.8rem', fontSize: '0.9rem', borderTop: '1px solid rgba(255,255,255,0.3)', paddingTop: '0.5rem'}}>
                                    Round {game.currentRound || 1}/{game.rounds}
                                </p>
                            </div>

                            {directionIndicator && (
                                <div className="direction-indicator">
                                    {directionIndicator}
                                </div>
                            )}
                        </>
                    )}

                    <div className="lake" style={{
                        width: '250px',
                        height: '180px',
                        left: '25%',
                        top: '35%'
                    }}></div>

                    <div className="house" style={{
                        width: '90px',
                        height: '70px',
                        left: '65%',
                        top: '25%'
                    }}></div>

                    <div className="tree" style={{ left: '15%', top: '20%' }}></div>
                    <div className="tree" style={{ left: '80%', top: '60%' }}></div>
                    <div className="tree" style={{ left: '10%', top: '70%' }}></div>
                    <div className="tree" style={{ left: '75%', top: '15%' }}></div>

                    {Object.entries(positions).map(([pId, pos]) => (
                        <div
                            key={pId}
                            className={`player ${wolf === pId ? 'wolf' : 'villager'} ${
                                activePower === 'invisibility' && pId === playerId ? 'invisible' : ''
                            }`}
                            style={{
                                left: `${pos.x}px`,
                                top: `${pos.y}px`,
                                display: caughtPlayers[pId] ? 'none' : 'flex'
                            }}
                        >
                            {wolf === pId ? 'üê∫' : 'üë§'}
                            <div className="player-name-tag">
                                {game.players[pId].name}
                            </div>
                        </div>
                    ))}

                    {(roundEnded || gameEnded) && (
                        <div className="end-screen">
                            <h1 className="end-title">
                                {gameEnded ? 'üèÜ Partie termin√©e!' : '‚úÖ Round termin√©!'}
                            </h1>
                            <div className="final-scores">
                                <h2 style={{marginBottom: '1.5rem', fontSize: '1.8rem'}}>
                                    {gameEnded ? 'Classement final' : 'Scores'}
                                </h2>
                                {playersList
                                    .sort((a, b) => b.score - a.score)
                                    .map((p, i) => (
                                        <div key={p.id} style={{
                                            fontSize: '1.3rem', 
                                            marginBottom: '0.8rem',
                                            padding: '0.5rem',
                                            background: i === 0 && gameEnded ? 'rgba(255,215,0,0.2)' : 'transparent',
                                            borderRadius: '5px'
                                        }}>
                                            {i === 0 && gameEnded && 'üëë '}
                                            {i + 1}. {p.name} - {p.score} points
                                        </div>
                                    ))}
                            </div>
                            {gameEnded ? (
                                <button className="btn btn-primary" onClick={() => setScreen('menu')}>
                                    Retour au menu
                                </button>
                            ) : (
                                <p style={{fontSize: '1.2rem', opacity: 0.8}}>
                                    Prochain round dans 5 secondes...
                                </p>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
